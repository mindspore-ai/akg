#!/usr/bin/env python3
# coding: utf-8
# Copyright 2025 Huawei Technologies Co., Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from swft.core import Tensor, Scalar, name_tensor
from swft.intrinsic import *
from copy import deepcopy
from swft.utils import *


@name_tensor
def vconcat(src0, src1=None):
    shape = deepcopy(src0.shape)
    shape[-1] = shape[-1] * 8
    dst = Tensor("UB", src0.dtype, shape, src0.format, src0.multi_core)
    if (src1 is None):
        Instruction("VCONCAT", (src0, ), (dst, ), {"type": [4]})()
        return dst
    Instruction("VCONCAT", (src0, src1, ), (dst, ), {"type": [4, 5]})()
    return dst


@name_tensor
def vsort16(src0):
    dst = Tensor("UB", src0.dtype, src0.shape, src0.format, src0.multi_core)
    Instruction("VBITSORT16", (src0, ), (dst, ))()
    return dst


@name_tensor
def vmrgsort4(src0, src1=None, src2=None, src3=None):
    shape = deepcopy(src0.shape)
    if (src1 == None):
        dst = Tensor("UB", src0.dtype, shape, src0.format, src0.multi_core)
        Instruction("VMRGSORT4", (src0, ), (dst, ), {"config": [1]})()
        return dst
    shape[-1] += src1.shape[-1]
    if (src2 == None):
        dst = Tensor("UB", src0.dtype, shape, src0.format, src0.multi_core)
        Instruction("VMRGSORT4", (src0, src1), (dst, ), {"config": [3]})()
        return dst
    shape[-1] += src2.shape[-1]
    if (src3 == None):
        dst = Tensor("UB", src0.dtype, shape, src0.format, src0.multi_core)
        Instruction("VMRGSORT4", (src0, src1, src2), (dst, ), {"config": [7]})()
        return dst
    shape[-1] += src3.shape[-1]
    dst = Tensor("UB", src0.dtype, shape, src0.format, src0.multi_core)
    Instruction("VMRGSORT4", (src0, src1, src2, src3), (dst, ), {"config": [15]})()
    return dst


@name_tensor
def vextract(src):
    shape = deepcopy(src.shape)
    shape[-1] = shape[-1] // 8
    dst0 = Tensor("UB", src.dtype, shape, src.format, src.multi_core)
    Instruction("VEXTRACT", (src, ), (dst0, ), {"type": [4]})()
    dst1 = Tensor("UB", src.dtype, shape, src.format, src.multi_core)
    Instruction("VEXTRACT", (src, ), (dst1, ), {"type": [5]})()
    return dst0, dst1
